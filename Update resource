private void handleRejoin(Resource res) {
    int rejoinYear = res.getStartDate().getYear();
    int rejoinMonth = res.getStartDate().getMonthValue(); // 1-12
    String psid = res.getPsid();
    String team = res.getTeam();

    // ✅ 1. Check for a service break (same as before)
    Optional<Resource> existingRes = resourceService.findById(psid);
    LocalDate prevEndDate = existingRes.map(Resource::getEndDate).orElse(null);
    boolean hadBreak = (prevEndDate != null && prevEndDate.isBefore(res.getStartDate()));

    // --- AVAILABILITY ---

    // ✅ 2. Get-or-Create CURRENT Year Availability
    AvailabilityCompositeId currentAvailId = new AvailabilityCompositeId(psid, rejoinYear, team);
    Availability availCurr = availabilityRepository.findById(currentAvailId)
            .orElseGet(() -> createEmptyAvailability(res, rejoinYear, BigDecimal.ZERO)); // If not found, create a new empty one
    
    updateAvailabilityForRejoin(availCurr, rejoinMonth, hadBreak);
    availabilityRepository.save(availCurr); // Saves new or updates existing

    // ✅ 3. Get-or-Create NEXT Year Availability
    AvailabilityCompositeId nextAvailId = new AvailabilityCompositeId(psid, rejoinYear + 1, team);
    Availability availNext = availabilityRepository.findById(nextAvailId)
            .orElseGet(() -> createEmptyAvailability(res, rejoinYear + 1, BigDecimal.ZERO)); // If not found, create a new empty one
    
    updateAvailabilityForRejoin(availNext, 12, false); // 12 = full year, no break
    availabilityRepository.save(availNext); // Saves new or updates existing

    // --- HOLIDAYS ---

    // ✅ 4. Get-or-Create CURRENT Year Holidays
    HolidayPlannerCompositeId currentHpId = new HolidayPlannerCompositeId(psid, rejoinYear);
    HolidayPlanner hpCurr = holidayPlannerRepository.findById(currentHpId)
            .orElseGet(() -> new HolidayPlanner(currentHpId, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO));
    
    resetHolidays(hpCurr); // Reset to zero (is redundant for new, but safe)
    holidayPlannerRepository.save(hpCurr);

    // ✅ 5. Get-or-Create NEXT Year Holidays
    HolidayPlannerCompositeId nextHpId = new HolidayPlannerCompositeId(psid, rejoinYear + 1);
    HolidayPlanner hpNext = holidayPlannerRepository.findById(nextHpId)
            .orElseGet(() -> new HolidayPlanner(nextHpId, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO));

    resetHolidays(hpNext);
    holidayPlannerRepository.save(hpNext);
    
    // ✅ 6. Log rejoin event (same as your code)
    ChangeLog log = getChangeLog("Resource rejoined: " + psid
        + ", Name: " + res.getName()
        + ", Team: " + team
        + ", Rejoin Date: " + res.getStartDate());
    resourceService.addResourceLog(log);
}

// --- REQUIRED HELPER METHODS ---
// You must have these three methods available in your class.

/**
 * Updates an existing Availability record for a rejoin.
 * (This is the minimal helper from the previous step)
 */
private void updateAvailabilityForRejoin(Availability avail, int rejoinMonth, boolean hadBreak) {
    BigDecimal one = BigDecimal.ONE;
    BigDecimal zero = BigDecimal.ZERO;
    
    // 0=Dec, 1=Jan, ... 11=Nov
    int financialMonthIndex = (rejoinMonth == 12) ? 0 : rejoinMonth;

    BigDecimal[] months = new BigDecimal[12];
    for (int i = 0; i < 12; i++) {
        if (i >= financialMonthIndex) {
            months[i] = one; // Available from rejoin month
        } else {
            months[i] = hadBreak ? zero : one; // If no break, they were available
        }
    }
    avail.setDece(months[0]); avail.setJan(months[1]); avail.setFeb(months[2]);
    avail.setMar(months[3]); avail.setApr(months[4]); avail.setMay(months[5]);
    avail.setJun(months[6]); avail.setJul(months[7]); avail.setAug(months[8]);
    avail.setSept(months[9]); avail.setOct(months[10]); avail.setNov(months[11]);
}

/**
 * Resets all months in a HolidayPlanner to zero.
 * (This is the minimal helper from the previous step)
 */
private void resetHolidays(HolidayPlanner hp) {
    BigDecimal zero = BigDecimal.ZERO;
    hp.setDece(zero); hp.setJan(zero); hp.setFeb(zero);
    hp.setMar(zero); hp.setApr(zero); hp.setMay(zero);
    hp.setJun(zero); hp.setJul(zero); hp.setAug(zero);
    hp.setSept(zero); hp.setOct(zero); hp.setNov(zero);
}

/**
 * Creates a new, empty Availability object (all months 0).
 * (This is from your original addResource logic).
 */
private Availability createEmptyAvailability(Resource res, int year, BigDecimal unAvailVal) {
    AvailabilityCompositeId id = new AvailabilityCompositeId(res.getPsid(), year, res.getTeam());
    return new Availability(id, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal, unAvailVal);
}
