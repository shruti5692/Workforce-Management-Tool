public void ensureAvailabilityAndHoliday(Resource res, int year) {
    BigDecimal one = new BigDecimal("1.0");
    BigDecimal zero = BigDecimal.ZERO;

    // --- Step 1: Reset or create full availability ---
    AvailabilityCompositeid aid = new AvailabilityCompositeid(res.getPsid(), year, res.getTeam());
    Availability avail = new Availability(aid,
            one, one, one, one,
            one, one, one, one,
            one, one, one, one);

    // Always overwrite to make sure rejoined resource is fully available
    availabilityRepository.save(avail);
    System.out.println("Availability reset to 1.0 for PSID: " + res.getPsid() + ", year: " + year);

    // --- Step 2: Ensure HolidayPlanner exists ---
    HolidayPlannerCompositeId hpId = new HolidayPlannerCompositeId(res.getPsid(), year);
    Optional<HolidayPlanner> existingHoliday = holidayPlannerRepository.findById(hpId);

    if (!existingHoliday.isPresent()) {
        HolidayPlanner holidayPlanner = new HolidayPlanner(
                hpId,
                zero, zero, zero, zero,
                zero, zero, zero, zero,
                zero, zero, zero, zero);
        holidayPlannerRepository.save(holidayPlanner);
        System.out.println("Holiday planner created for PSID: " + res.getPsid() + ", year: " + year);
    } else {
        System.out.println("Holiday planner already exists for PSID: " + res.getPsid());
    }
}




// --- existing declarations above ---

// --- ðŸ§© Rejoin handling starts here ---
LocalDate today = LocalDate.now();

// Case: resource was inactive (ended earlier) and now rejoins
if (oldEndDate.isBefore(today) && newEndDate.isAfter(today)) {
    System.out.println("Rejoin detected for PSID: " + res.getPsid());

    // regenerate availability and holidays for current & next financial year
    resourceService.ensureAvailabilityAndHoliday(res, currYear);
    resourceService.ensureAvailabilityAndHoliday(res, currYear + 1);
}
// --- ðŸ§© Rejoin handling ends here ---

// Continue with your existing postponement/preponement logic
int newEndDateYear = newEndDate.getYear();
int newEndDateMonth = newEndDate.getMonthValue();

// ... rest of your existing code (postponement / preponement) ...
