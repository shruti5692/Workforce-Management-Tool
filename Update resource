public void ensureAvailabilityAndHoliday(Resource res, int year) {
    boolean availabilityExists =
        availabilityRepository.existsAllByAvailabilityId_AvailabilityYearAndAvailabilityId_Psid(year, res.getPsid());
    boolean holidayExists =
        holidayPlannerRepository.existsAllByHolidayPlannerId_HolidayYearAndHolidayPlannerId_Psid(year, res.getPsid());

    if (!availabilityExists) {
        BigDecimal full = new BigDecimal("1.0");
        AvailabilityCompositeld avid = new AvailabilityCompositeld(res.getPsid(), year, res.getTeam());
        Availability avail = new Availability(avid, full, full, full, full, full, full, full, full, full, full, full, full);
        addAvailability(avail);  // use your existing addAvailability() service
    }

    if (!holidayExists) {
        HolidayPlannerCompositeld hpci = new HolidayPlannerCompositeld(res.getPsid(), year);
        BigDecimal zero = new BigDecimal("0");
        HolidayPlanner hp = new HolidayPlanner(hpci, zero, zero, zero, zero, zero, zero, zero, zero, zero, zero, zero, zero);
        holidayPlannerRepository.save(hp);
    }
}




// --- existing declarations above ---

// --- ðŸ§© Rejoin handling starts here ---
LocalDate today = LocalDate.now();

// Case: resource was inactive (ended earlier) and now rejoins
if (oldEndDate.isBefore(today) && newEndDate.isAfter(today)) {
    System.out.println("Rejoin detected for PSID: " + res.getPsid());

    // regenerate availability and holidays for current & next financial year
    resourceService.ensureAvailabilityAndHoliday(res, currYear);
    resourceService.ensureAvailabilityAndHoliday(res, currYear + 1);
}
// --- ðŸ§© Rejoin handling ends here ---

// Continue with your existing postponement/preponement logic
int newEndDateYear = newEndDate.getYear();
int newEndDateMonth = newEndDate.getMonthValue();

// ... rest of your existing code (postponement / preponement) ...
