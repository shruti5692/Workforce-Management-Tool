public void ensureAvailabilityAndHoliday(Resource res, int year) {
    // Check if availability for this year already exists
    boolean exists = availabilityRepository.existsAllByAvailabilityId_AvailabilityYearAndAvailabilityId_Psid(year, res.getPsid());
    if (!exists) {
        System.out.println("Creating availability for PSID: " + res.getPsid() + " year: " + year);

        // --- Create Availability (All months = 1.0) ---
        BigDecimal availVal = new BigDecimal("1.0");
        AvailabilityCompositeid availabilityId = new AvailabilityCompositeid(res.getPsid(), year, res.getTeam());

        Availability availability = new Availability(
                availabilityId,
                availVal, availVal, availVal, availVal,
                availVal, availVal, availVal, availVal,
                availVal, availVal, availVal, availVal
        );
        availabilityRepository.save(availability);
    }

    // Check if holiday planner entry exists for this year
    HolidayPlannerCompositeId hpId = new HolidayPlannerCompositeId(res.getPsid(), year);
    Optional<HolidayPlanner> existingHoliday = holidayPlannerRepository.findById(hpId);

    if (!existingHoliday.isPresent()) {
        System.out.println("Creating holiday planner for PSID: " + res.getPsid() + " year: " + year);

        // --- Create Holiday Planner (All months = 0.0) ---
        BigDecimal zero = BigDecimal.ZERO;
        HolidayPlanner holidayPlanner = new HolidayPlanner(
                hpId,
                zero, zero, zero, zero,
                zero, zero, zero, zero,
                zero, zero, zero, zero
        );
        holidayPlannerRepository.save(holidayPlanner);
    }
}




// --- existing declarations above ---

// --- ðŸ§© Rejoin handling starts here ---
LocalDate today = LocalDate.now();

// Case: resource was inactive (ended earlier) and now rejoins
if (oldEndDate.isBefore(today) && newEndDate.isAfter(today)) {
    System.out.println("Rejoin detected for PSID: " + res.getPsid());

    // regenerate availability and holidays for current & next financial year
    resourceService.ensureAvailabilityAndHoliday(res, currYear);
    resourceService.ensureAvailabilityAndHoliday(res, currYear + 1);
}
// --- ðŸ§© Rejoin handling ends here ---

// Continue with your existing postponement/preponement logic
int newEndDateYear = newEndDate.getYear();
int newEndDateMonth = newEndDate.getMonthValue();

// ... rest of your existing code (postponement / preponement) ...
