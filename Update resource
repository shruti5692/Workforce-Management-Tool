public void ensureAvailabilityAndHoliday(Resource res, int year) {
    boolean availabilityExists =
        availabilityRepository.existsAllByAvailabilityId_AvailabilityYearAndAvailabilityId_Psid(year, res.getPsid());
    boolean holidayExists =
        holidayPlannerRepository.existsAllByHolidayPlannerId_HolidayYearAndHolidayPlannerId_Psid(year, res.getPsid());

    if (!availabilityExists) {
        BigDecimal full = new BigDecimal("1.0");
        AvailabilityCompositeld avid = new AvailabilityCompositeld(res.getPsid(), year, res.getTeam());
        Availability avail = new Availability(avid, full, full, full, full, full, full, full, full, full, full, full, full);
        addAvailability(avail);  // use your existing addAvailability() service
    }

    if (!holidayExists) {
        HolidayPlannerCompositeld hpci = new HolidayPlannerCompositeld(res.getPsid(), year);
        BigDecimal zero = new BigDecimal("0");
        HolidayPlanner hp = new HolidayPlanner(hpci, zero, zero, zero, zero, zero, zero, zero, zero, zero, zero, zero, zero);
        holidayPlannerRepository.save(hp);
    }
}




@RequestMapping(value = "/updateResource", method = RequestMethod.POST)
public boolean updateResource(@RequestBody final Resource res) {

    boolean flag = false;
    AddResourceResponse arr = new AddResourceResponse();
    AddResourceResponse arr1 = new AddResourceResponse();

    Resource oldres = resourceService.findById1(res.getPsid());

    LocalDate oldEndDate = oldres.getEndDate();
    LocalDate newEndDate = res.getEndDate();

    int currYear = Calendar.getInstance().get(Calendar.YEAR);
    int currMonth = Calendar.getInstance().get(Calendar.MONTH);
    if (currMonth == 11) currYear++;

    // ðŸ§© Step 1: Detect rejoin case
    // A resource rejoined if previously endDate was old (inactive) and now set to future (active again)
    boolean isRejoining = oldEndDate.isBefore(LocalDate.now()) && newEndDate.isAfter(LocalDate.now());

    if (isRejoining) {
        // ðŸ§© Step 2: Recreate availability and holidays for current + next FY
        resourceService.ensureAvailabilityAndHoliday(res, currYear);
        resourceService.ensureAvailabilityAndHoliday(res, currYear + 1);
    }

    // âœ… Everything else remains same (postponement / preponement logic)
    int newEndDateYear = newEndDate.getYear();
    int newEndDateMonth = newEndDate.getMonthValue();

    //update allocation table values for resource if end date is changed
    if (!oldEndDate.equals(newEndDate)) {
        resourceService.updateAllocationToZero(res.getPsid(), newEndDateYear, newEndDateMonth);

        for (int year = currYear; year <= currYear + 1; year++) {
            List<ResourceAvailability> reslist = resourceService.getResAvail(year, res.getPsid(), res);
            resourceService.updateTeamAvailability(year, res.getPsid(), res, reslist);
        }
    }

    // existing postponement & preponement logic follows below...
    // (do not change that part)

    arr1.updateResourceLog(oldres, res);
    arr.setCreated(this.resourceService.updateResource(res));

    return arr.isCreated();
}
